#!/usr/bin/env bash

usage() {
	echo "Run the current project based on contents of package.json" >&2
	echo >&2
	echo "usage:" >&2
	echo "  $(basename "${0}") <mode>" >&2
	echo >&2
	echo "mode:" >&2
	echo "  (default)  Run the project" >&2
	echo "  test       Run test suites; and watch for file changes" >&2
	echo "  cover      Run test suites just for code coverage" >&2
	echo >&2

	if [ -n "${1}" ]; then echo -e "${A_CS} error: ${1} ${N_CS}" >&2; fi >&2

	exit 1
}

if [[ "${1}" =~ ^-?-h(elp)?$ ]]; then usage ''; fi

filename='package.json'

while ! [ -f "${filename}" ] && [ "$(pwd)" != '/' ]; do
	cd ..
done

if ! [ -f "${filename}" ]; then
	usage "No ${filename} directory found in path; better luck next time."
fi

npx='npx'

if [ "$(jq -rc '.engines.yarn' package.json)" != 'null' ]; then npx=yarn; fi

dev_script="$(jq -rc '.scripts.dev' package.json)"
start_script="$(jq -rc '.scripts.start' package.json)"
test_script="$(jq -rc '.scripts.test' package.json)"
main_script="$(jq -rc '.main' package.json)"

server_dir="server"
if [ ! -d "${server_dir}" ]; then server_dir="src"; fi
if [ ! -d "${server_dir}" ]; then server_dir="."; fi

watch_dirs=()
if [ ! -d "${server_dir}/api" ]; then watch_dirs+=( '--watch' "${server_dir}" ); fi
if [ -d "${server_dir}/api" ]; then watch_dirs+=( '--watch' "${server_dir}/api" ); fi
if [ -d "${server_dir}/config" ]; then watch_dirs+=( '--watch' "${server_dir}/config" ); fi
if [ -d 'common' ]; then watch_dirs+=( '--watch' 'common' ); fi

test_path='src/api/**/*.test.js'
if [ -d 'server/tests' ]; then test_path='server/tests'; fi

watch_dir="${server_dir}"
if [ -d "${watch_dir}/api" ]; then watch_dir="${watch_dir}/api"; fi
if [ -d 'common' ]; then watch_dir="${watch_dir},common"; fi

mode="${1:-default}"

if [[ "${mode}" =~ default ]]; then
	if [[ "${dev_script}" =~ nodemon ]]; then
		clear
		clear
		echo -e "${S_CS} Hosting via ${npx} nodemon ${N_CS}" >&2
		restore_node_env="${NODE_ENV}"
		restore_log_level="${LOG_LEVEL}"
		set_node_env='dev1'
		if [ "${npx}" = 'yarn' ]; then set_node_env='development'; fi
		export NODE_ENV="${set_node_env}"
		export LOG_LEVEL=debug
		# npx nodemon server/server.js --watch common --watch server
		$npx nodemon "./${main_script}" "${watch_dirs[@]}"
		export NODE_ENV="${restore_node_env}"
		export LOG_LEVEL="${restore_log_level}"

	# elif [ "${dev_script}" != 'null' ]; then
	# 	clear
	# 	clear
	# 	echo -e "${S_CS} Running dev script ${N_CS}" >&2
	# 	npm run dev

	elif [ "${start_script}" != 'null' ]; then
		clear
		clear
		echo -e "${S_CS} Running npm start ${N_CS}" >&2
		npm start

	else
		echo -e "dev_script:     '${dev_script}'" >&2
		echo -e "start_script:   '${start_script}'" >&2
		usage 'I dunno how run'
	fi

elif [[ "${mode}" =~ test ]]; then
	if [ "${test_script}" = 'ng test' ]; then
		clear
		clear
		echo -e "${S_CS} Testing via ${npx} ng test watch=true ${N_CS}" >&2
		$npx ng test --watch=true --code-coverage --source-map

	elif [[ "${test_script}" =~ mocha ]]; then
		clear
		clear
		echo -e "${S_CS} Testing via ${npx} nyc mocha watch=true ${N_CS}" >&2
		restore_node_env="${NODE_ENV}"
		restore_log_level="${LOG_LEVEL}"
		set_node_env='UNIT_TEST'
		if [ "${npx}" = 'yarn' ]; then set_node_env='development'; fi
		export NODE_ENV="${set_node_env}"
		export LOG_LEVEL=warn
		# $npx nyc --reporter=lcov "${npx}" mocha --recursive "${test_path}" -w --watch-files "${watch_dir}"
		$npx mocha "${test_path}" --exit
		export NODE_ENV="${restore_node_env}"
		export LOG_LEVEL="${restore_log_level}"

	elif [ "${test_script}" != 'null' ]; then
		echo -e "${A_CS}Maybe it's like: ${N_CS}" >&2
		echo "${test_script}" >&2
		echo -e "${E_CS}but I'm not sure. ${N_CS}" >&2

	else
		usage 'I dunno how test'
	fi

elif [[ "${mode}" =~ cover ]]; then
	rm -rf './coverage'

	if [ "${test_script}" = 'ng test' ]; then
		clear
		clear
		echo -e "${S_CS} Testing via ${npx} ng test watch=false ${N_CS}" >&2
		$npx ng test --watch=false --code-coverage --source-map

		if [ -f './coverage/index.html' ]; then
			open -a 'Google Chrome' './coverage/index.html'
		else
			echo -e "${W_CS} Dunno where the coverage report is. ${N_CS}" >&2
		fi

	elif [[ "${test_script}" =~ mocha ]]; then
		clear
		clear
		echo -e "${S_CS} Testing via nyc mocha ${N_CS}" >&2
		node_env="${NODE_ENV}"
		log_level="${LOG_LEVEL}"
		export NODE_ENV=UNIT_TEST
		export LOG_LEVEL=warn
		# npx nyc --reporter=lcov npx mocha --recursive server/tests --diff
		$npx nyc --reporter=lcov "${npx}" mocha --exit --recursive "${test_path}"
		export NODE_ENV="${node_env}"
		export LOG_LEVEL="${log_level}"

	elif [ "${test_script}" != 'null' ]; then
		echo -e "${A_CS}Maybe it's like: ${N_CS}" >&2
		echo "${test_script}" >&2
		echo -e "${E_CS}but I'm not sure. ${N_CS}" >&2

	else
		usage 'I dunno how cover'
	fi

elif [[ "${mode}" =~ check ]]; then

	echo -e "npx:            '${npx}'" >&2
	echo >&2
	echo -e "dev_script:     '${dev_script}'" >&2
	echo -e "start_script:   '${start_script}'" >&2
	echo -e "test_script:    '${test_script}'" >&2
	echo -e "main_script:    '${main_script}'" >&2
	echo >&2
	echo -e "server_dir:     '${server_dir}'" >&2
	echo -e "watch_dir:      '${watch_dir}'" >&2
	echo >&2

	echo -e "${S_CS} (default) ${N_CS}" >&2
	if [[ "${dev_script}" =~ nodemon ]]; then
		echo -e "\t" npx nodemon ./server/server.js --watch server --watch common >&2
		echo -e "\t" "${npx}" nodemon "./${main_script}" "${watch_dirs[@]}"
		echo -e "\t" yarn nodemon ./src/index.js --watch src/api --watch src/config >&2
	elif [ "${dev_script}" != 'null' ]; then
		echo -e "\t" npm run dev
	elif [ "${start_script}" != 'null' ]; then
		echo -e "\t" npm start
	else
		echo -e "\t" usage "'I dunno how run'"
	fi

	echo -e "${S_CS} test ${N_CS}" >&2
	if [ "${test_script}" = 'ng test' ]; then
		echo -e "\t" ng test --watch=true --code-coverage --source-map
	elif [[ "${test_script}" =~ mocha ]]; then
		echo -e "\t"    npx   nyc --reporter=lcov    npx   mocha --recursive server/tests           -w --watch-files server,common >&2
		echo -e "\t" "${npx}" nyc --reporter=lcov "${npx}" mocha --recursive "${test_path}"         -w --watch-files "${watch_dir}"
		echo -e "\t"    yarn  nyc --reporter=lcov    yarn  mocha --recursive 'src/api/**/*.test.js' -w --watch-files src/api >&2
	elif [ "${test_script}" != 'null' ]; then
		echo -e "\t" usage "'maybe just npm run test'"
	else
		echo -e "\t" usage "'I dunno how test'"
	fi

	echo -e "${S_CS} cover ${N_CS}" >&2
	if [ "${test_script}" = 'ng test' ]; then
		echo -e "\t" ng test --watch=false --code-coverage --source-map
	elif [[ "${test_script}" =~ mocha ]]; then
		echo -e "\t"    npx   nyc --reporter=lcov    npx   mocha --exit --recursive server/tests >&2
		echo -e "\t" "${npx}" nyc --reporter=lcov "${npx}" mocha --exit --recursive "${test_path}"
		echo -e "\t"    yarn  nyc --reporter=lcov    yarn  mocha --exit --recursive 'src/api/**/*.test.js' >&2
	elif [ "${test_script}" != 'null' ]; then
		echo -e "\t" usage "'maybe just npm run test'"
	else
		echo -e "\t" usage "'I dunno how cover'"
	fi

else
	usage "I dunno how to $mode"
fi

echo -e "${S_CS} Okay, all done. ${N_CS}" >&2
