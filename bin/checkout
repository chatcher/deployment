#!/usr/bin/env bash

set -e
set -x

usage() {
	echo "Checkout the specified Branch or Pull Request" >&2
	echo >&2
	echo "usage:" >&2
	echo "  $(basename "${0}") <branch|prn>" >&2
	echo >&2

	if [ -n "${1}" ]; then echo "error: ${1}" >&2; fi

	exit 1
}

initial="$(get-current-branch)"

branch="${1:-dev}"

if [ -z "${initial}" ]; then
	usage "Couldn't figure out initial branch."
fi

if [[ "${branch}" =~ ^[0-9]+$ ]]; then
	pr_branch="$(get-pull-request "${branch}" | jq -r '.head' )"
	if [ -z "${pr_branch}" ]; then usage "Couldn't find a branch for PR #${branch}."; fi
	branch="${pr_branch}"	
fi

if [ -z "${branch}" ]; then usage "Branch or Pull Request Number required."; fi

if has-local-branch "${branch}"; then
	echo "Checking out local branch..." >&2
	git checkout "${branch}"
	
elif has-remote-branch  "${branch}"; then
	echo "Checking out remote branch..." >&2
	git checkout "${branch}"

else
	echo "Creating new branch..." >&2
	git checkout -bt "${branch}"
fi

git pull
git branch -d "${initial}"
