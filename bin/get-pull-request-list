#!/bin/bash

set -e

usage() {
	echo "Fetch the list of Pull Requests for the current repo." >&2
	echo >&2
	echo "usage:" >&2
	echo "  $(basename "${0}")" >&2
	echo >&2

	if [ -n "${1}" ]; then echo -e "${A_CS} error: ${1} ${N_CS}" >&2; fi

	exit 1
}

if [[ "${1}" =~ ^-?-h(elp)?$ ]]; then usage ''; fi

GITHUB_AUTH_HEADER="Authorization: bearer ${GITHUB_TOKEN}"

response="$(curl -H "${GITHUB_AUTH_HEADER}" "$(get-repo-api)/repos/$(get-repo-name)/pulls" -s)"

message="$(jq -r '.message' <<< "${response}" 2>/dev/null || :)"

if [ -n "${message}" ]; then usage "${message}"; fi

jq -c '.[] | {number:.number,state:.state,head:.head.ref,base:.base.ref,link:._links.html.href,title:.title,user:.user.login,body:.body}' <<< "${response}"
