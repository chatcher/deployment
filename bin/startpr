#!/usr/bin/env bash

set -e
set -x

usage() {
	echo "Create a draft Pull Request from the staged changes." >&2
	echo >&2
	echo "usage:" >&2
	echo "  $(basename "${0}") <title>" >&2
	echo >&2

	if [ -n "${1}" ]; then echo -e "${A_CS} error: ${1} ${N_CS}" >&2; fi

	exit 1
}

if [[ "${1}" =~ ^-?-h(elp)?$ ]]; then usage ''; fi

if (( $# == 0 )); then usage "PR title required."; fi

if ! has-staged-changes; then
	echo -e "${W_CS} I don't see staged changes. ${N_CS}" >&2
	if prompt 'Do you want to create a Pull Request from the current commit?'; then
		createpr "${@}"
		exit
	else
		usage "Expected staged changes."
	fi
fi

if [ "${1}" == '-b' ]; then
	shift
	shift
fi

checkout "tmp/$(date +%s)"
git commit -S -m "${*}" --no-verify
createpr "${@}"
